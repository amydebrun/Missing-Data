---
title: "missingness analysis"
author: "Amy, Kent"
date: "2025-02-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mice)
library(sjPlot)
library(zoo)
library(nlme)
library(tidyverse)
library(haven)
```

## R Markdown


```{r}
data_vitalkp <- read_sas("Data/vitalkneepain111623.sas7bdat", 
                         NULL)
data_main <- read_sas("Data/VITAL_trial_NEJM_2022.sas7bdat", 
                      NULL)

data_vital<- data_main %>%
  select(Subject_ID, vitdactive, fishoilactive, sex, ageyr) %>%
  right_join(data_vitalkp, by = "Subject_ID")

head(data_vital)

acupuncture <- read_csv("Data/acupuncture.csv",show_col_types = FALSE)

```

## Last Observation Carried Forward

```{r} 
#locf function on vital data zoo package
LOCF_vital<-as.data.frame(na.locf(data_vital, fromLast=TRUE))
```

```{r}
#locf function on acupuncture data zoo package
LOCF_acupuncture<-as.data.frame(na.locf(acupuncture, fromLast=TRUE))
```

```{r}
#treatment effect for acupuncture LOCF
acu_model<- lm(pk2~group+sex+migraine+pk1+chronicity, data=acupuncture)
LOCF_acu_model<- lm(pk2~group+sex+migraine+pk1+chronicity, data=LOCF_acupuncture)
```

```{r}
#treatment effect for vital LOCF

vital_model<- lme(pain_yr4~vitdactive*fishoilactive+sex+ageyr+pain_base, data=data_vital, random=pain_base|)
```


## Complete Case Analysis

```{r}
#complete case on acupuncture
acu_complete<- as.data.frame(acupuncture[complete.cases(acupuncture), , drop=FALSE])
acu_complete_model<-lm(pk2~group+sex+migraine+pk1+chronicity, data=acu_complete)
```


## MICE package

```{r, message=FALSE}
#Multiple imputation chained equations on acupuncture data
acu_mice<- mice(acupuncture, m = 5, method = 'pmm', seed = 123)
acu_mice_model <- with(acu_mice, lm(pk2~group+sex+migraine+pk1+chronicity))
acu_pooled_model<- pool(acu_mice_model)
summary(acu_pooled_model)
```
```{r}
stripplot(acu_mice, pch=1, cex=1.2)
```

```{r}
#table of complete case, locf and regular model for acupuncture 
tab_model(acu_model, acu_complete_model, LOCF_acu_model )
```

