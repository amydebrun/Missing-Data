---
title: "missingness analysis"
author: "Amy, Kent"
date: "2025-02-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mice)
library(sjPlot)
library(zoo)
library(nlme)
library(tidyverse)
library(haven)
library(dplyr)
```

## R Markdown


```{r}
data_vitalkp <- read_sas("Data/vitalkneepain111623.sas7bdat", 
                         NULL)
data_main <- read_sas("Data/VITAL_trial_NEJM_2022.sas7bdat", 
                      NULL)

vital_wide<- data_main %>%
  dplyr::select(Subject_ID, vitdactive, fishoilactive, sex, ageyr, ) %>%
  right_join(data_vitalkp, by = "Subject_ID")

acu_wide <- read_csv("Data/acupuncture.csv",show_col_types = FALSE)

```
## data from wide to long 


```{r message=FALSE}
a<-acu_wide %>%
  pivot_longer(
    cols = c('pk2', 'pk5'), 
    names_to = c('pk_time'),
    names_repair = "unique"
  )

acu_long<-a %>%
  pivot_longer(
    cols = c('f2', 'f5'), 
    names_to = c('freq_time'),
    names_repair = "unique"
  )
colnames(acu_long)[12]<-"pk_score"
colnames(acu_long)[14]<-"freq_score"

v<-vital_wide%>%
    pivot_longer(
    cols = c('pain_yr1','pain_yr2', 'pain_yr3', 'pain_yr4'), 
    names_to = c('pain_time'),
    names_repair = "unique"
  )
x<-v%>%
    pivot_longer(
    cols = c('stiffness_yr1', 'stiffness_yr2', 'stiffness_yr3', 'stiffness_yr4'), 
    names_to = c('stiffness_time'),
    names_repair = "unique"
    )
vital_long<-x%>%
    pivot_longer(
    cols = c('function_yr1', 'function_yr2', 'function_yr3', 'function_yr4'), 
    names_to = c('function_time'),
    names_repair = "unique"
    )
colnames(vital_long)[18]<-"pain_score"
colnames(vital_long)[20]<-"stiffness_score"
colnames(vital_long)[22]<-"function_score"
head(acu_long)
head(vital_long)
```


## Last Observation Carried Forward

```{r}
#LOCF function
LOCF <- function(data, columns){
  for (col in columns) {
    for (i in 1:nrow(data)) {  
      if (is.na(data[i, col])) {
        data[i, col] <- data[i, col - 1]  
      }
    }
  }
  return(data)  
}

acu_LOCF <- acu_wide
acu_LOCF <- LOCF(data = acu_LOCF, columns = c(10,11))
head(acu_LOCF)

vital_LOCF<- vital_wide
vital_LOCF<- LOCF(data = vital_LOCF, columns = c(9, 10,11,15,16,17,18,19,20,22,23))
head(vital_LOCF)
```

```{r} 
#locf function on vital data zoo package
LOCF_vital<-as.data.frame(na.locf(vital_wide, fromLast=TRUE))
```

```{r}
#locf function on acupuncture data zoo package
LOCF_acupuncture<-as.data.frame(na.locf(acu_wide, fromLast=TRUE))
```

```{r}
#models from zoo package locf
LOCF_fishoil_model<- lm(pain_yr4~fishoilactive+sex+ageyr+pain_base, data=LOCF_vital)
LOCF_vitD_model<-lm(pain_yr4~vitdactive+sex+ageyr+pain_base, data=LOCF_vital)
```


## Complete Case Analysis - just use linear model as it removes rows with NA values 

```{r}
#complete case on acupuncture
acu_complete<- lm(pk_score~group*pk_time, data=acu_long)
LOCF_acu_model<- lm(pk5~group*pk1, data=acu_LOCF)
```


## MICE package

```{r, message=FALSE}
#Multiple imputation chained equations on acupuncture data
acu_mice<- mice(acu_wide, m = 5, method = 'pmm', seed = 123)
acu_mice_model <- with(acu_mice, lm(pk5~group+pk1))
acu_pooled_model<- pool(acu_mice_model)
summary(acu_pooled_model)
```

```{r}
#table of complete case, locf and regular model for acupuncture 
tab_model(acu_complete, LOCF_acu_model )
```


## Mixed Effects Model

```{r message=FALSE, warning=FALSE}
library(lme4)
acu_LME<- lmer(pk_score ~ group*pk_time + (1| id), data=acu_long)
vitD_LME<-lmer(pain_score~vitdactive*pain_time + (1|Subject_ID), data=vital_long)
fishoil_LME<-lmer(pain_score~fishoilactive*pain_time+ (1|Subject_ID), data=vital_long)

summary(acu_LME) 
summary(vitD_LME)
summary(fishoil_LME)
```



#extra code
```{r warning=FALSE
head(acupuncture)
acu_long <- reshape(acupuncture, 
                    varying = c('pk1', 'pk2', 'pk5', 'f1', 'f2', 'f5'),
                    v.names = 'value', 
                    times = c('pk1', 'pk2', 'pk5', 'f1', 'f2', 'f5'),
                    direction = 'long'

vital_long<-reshape(data_vital, 
                    varying = c('vitdactive', 'fishoilactive', 'sex', 'ageyr', 'pain_base', 
                                'stiffness_base', 'function_base', 'pain_yr1', 'stiffness_yr1', 'function_yr1', 'pain_yr2', 'stiffness_yr2', 'function_yr2','pain_yr3', 'stiffness_yr3', 'function_yr3', 'pain_yr4', 'stiffness_yr4', 'function_yr4', 'KneesReplacedV2','unikneepain','bikneepain','kneepainfreq','tylenolbase','nsaidsbase','strongerbase','tkrf'),
                    v.names = 'value', 
                    times = c('vitdactive', 'fishoilactive', 'sex', 'ageyr', 'pain_base', 
                                'stiffness_base', 'function_base', 'pain_yr1', 'stiffness_yr1', 'function_yr1', 'pain_yr2', 'stiffness_yr2', 'function_yr2','pain_yr3', 'stiffness_yr3', 'function_yr3', 'pain_yr4', 'stiffness_yr4', 'function_yr4', 'KneesReplacedV2','unikneepain','bikneepain','kneepainfreq','tylenolbase','nsaidsbase','strongerbase','tkrf'),
                    direction = 'long')
acu_long

functions
```{r
LOCF <- function(x) {
  v <- !is.na(x)
  c(NA, x[v])[cumsum(v)+1]
}
```

```{r
LOCF <- function(x) {
    LOCF <- max(which(!is.na(x)))
    x[LOCF:length(x)] <- x[LOCF]
    return(x)
}
data.frame(lapply(acupuncture, LOCF))
```
