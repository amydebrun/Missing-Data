---
title: Estimating Treatment Effects in Longitudinal Clinical Trials with Missing Data
author:
  - name: Amy Browne
  - name: Tsz Mang Yip
    affil: 1
affiliation:
  - num: 1
    address: School of Mathematical and Statistical Sciences, University of Galway

poster_height: "594mm"
poster_width: "841mm"
column_numbers: 4
font_family: "Arial"
column_margins: "0.3in"	
sectitle_textsize: "35pt"
primary_colour:	"#a80050"
secondary_colour:	"#84003d"
accent_colour:	"#000033"	
author_textcol: "white"
title_textsize: "55pt"
author_textsize: "35pt"
body_textsize: "20pt"
output: 
  posterdown::posterdown_html:
    self_contained: true
    pandoc_args: --mathjax
    number_sections: false
knit: pagedown::chrome_print
---

```{css, echo=FALSE}
div.logo_left{
  width: 20%;
}
div.poster_title{
  width: 80%;
}
.section h4 {
    break-after: column;
}
div.footnotes {
    font-size: 18pt;
}
```

<!-- Don't change anything above, except the title and author names, unless you know what you are doing. -->

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      tidy = FALSE,
                      message = FALSE,
                      fig.align = 'center',
                      out.width = "100%")
options(knitr.table.format = "html") 
# Load any additional libraries here
library(tidyverse)
library(plotly)
library(kableExtra)
library(haven)
library(scales)
```

# Outline

Missing data is often overlooked when analysing and reporting clinical trial results. Excluding observations on the basis of missing data can produce biased results and reduce statistical power. It is important to plan for and describe the occurrence of missing data and consider how such missing data should be incorporated in any analysis estimating a treatment in order to increase precision and reduce bias. 

# Missingness Mechanisms

- Missing Completely at Random (MCAR) - Missing data is independent of the study 
- Missing at Random - Uncertainty as to how the data is missing
- Missing Not at Random - Data is informatively missing  

# Our Data

The following graphs visualise the frequency of missingness within two clinical trial data sets. The first data set contains results of a longitudinal Randomised Control Trial which aimed to test the effectiveness of in taking Fish oil or Vitamin D on Knee Pain (MacFarlane et al., 2020)[^1] 
The following data set are results from another longitudinal randomised control trial in which the effectiveness of acupuncture on chronic headache was investigated (Vickers et al.,2004) [^2].

# Vitamin D and Fish Oil Trial

```{r}

data_vitalkp <- read_sas("Data/vitalkneepain111623.sas7bdat", 
                         NULL)
data_main <- read_sas("Data/VITAL_trial_NEJM_2022.sas7bdat", 
                      NULL)

data_combined <- data_main %>%
  select(Subject_ID, vitdactive, fishoilactive) %>%
  right_join(data_vitalkp, by = "Subject_ID")

data_miss <- data_combined %>%
  select(Subject_ID, tkrf, vitdactive, fishoilactive, starts_with("pain_")) %>%
  mutate(across(starts_with("pain_"), ~ as.numeric(!is.na(.x)), .names = "missing_{.col}")) %>%
  unite("miss_pattern", starts_with("missing_"), remove = FALSE) %>%
  rowwise() %>% 
  mutate(miss_count = sum(c_across(starts_with("missing_pain_")))) %>%
  group_by(miss_pattern) %>%
  mutate(pattern_freq = n()) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(miss_pattern = gsub("_", ", ", miss_pattern),
         miss_pattern_label = paste0("Pattern: ", miss_pattern, ", (n=", pattern_freq , ")", collapse = "")) %>%
  pivot_longer(starts_with("pain_"), names_to = "time", names_prefix = "pain_", 
               values_to = "pain") %>%
  mutate(
    miss_obs = as.factor(if_else(is.na(pain),0,1)),
    time_cont = case_when(
      time=="base" ~ 0,
      time=="yr1" ~ 1,
      time=="yr2" ~ 2,
      time=="yr3" ~ 3,
      time=="yr4" ~ 4
    )) %>%
  arrange(desc(miss_pattern), Subject_ID) %>%
  mutate(miss_pattern_label = factor(miss_pattern_label, levels = unique(miss_pattern_label)),
         group_vitd = factor(vitdactive, levels = c(0,1), labels = c("Placebo","Vitamin D")),
         group_oil = factor(fishoilactive, levels = c(0,1), labels = c("Placebo","Fish Oil")))
```

```{r mytable, echo=FALSE, fig.cap='Proportions of Missing Data over time in longitudinal trial (MacFarlane et al. 2020)', fig.height=9, fig.width=14}
## Ploting

pct_format = scales::label_percent(accuracy = .1)
suppressMessages(
data_miss %>%
  group_by(time, miss_obs) %>%
  summarise(count_pat = n(), .groups="keep") %>%
  group_by(time) %>%
  mutate(total_pat = sum(count_pat), perc_pat = pct_format(count_pat/total_pat)) %>%
  ungroup %>%
  ggplot(aes(x = time, fill = miss_obs, y = count_pat)) +
  geom_col() +  
  stat_identity(geom = "text", colour = "white", size = 10,
                aes(label =perc_pat), 
                position = position_stack(vjust=0.5)) +
scale_fill_manual(name="",values=c("olivedrab", "lawngreen"), labels=c("Missing Data", "Measured Data")) +
  scale_x_discrete(name = "Time", labels = c("base" = "Baseline", "yr1" = "Year 1", "yr2" = "Year 2", "yr3" = "Year 3", "yr4"="Year 4")) + 
  scale_y_continuous(name = "Number of Patients") +
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 0, vjust = 0.5),
        legend.position = "top", legend.text=element_text(size=20))
)
```


```{r mytable2, echo=FALSE, warning=FALSE, fig.cap='Proportions of missing data(dark green) overtime within treatment groups. Proportions are similar within each group.', fig.height=9, fig.width=15}

## Second plot
suppressMessages(
data_miss %>%
  group_by(time, miss_obs, group_vitd, group_oil) %>%
  summarise(count_pat = n(), .groups="keep") %>%
  group_by(time, group_vitd, group_oil) %>%
  mutate(total_pat = sum(count_pat), perc_pat = pct_format(count_pat/total_pat)) %>%
  ungroup %>%
  ggplot(aes(x = time, fill = miss_obs, y = count_pat)) +
  geom_col() +
  facet_grid(group_vitd~group_oil) + 
  stat_identity(geom = "text", colour = "white", size = 10,
                aes(label =perc_pat), 
                position = position_stack(vjust=0.5)) +
  scale_fill_manual(name="Data",values=c("olivedrab", "lawngreen"), labels=c("Missing", "Measured"))+
  scale_x_discrete(name = "Time", labels = c("base" = "Baseline", "yr1" = "Year 1", "yr2" = "Year 2", "yr3" = "Year 3", "yr4"="Year 4")) + 
  scale_y_continuous(name = "Number of Patients") +
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 0, vjust = 0.5), legend.position = "none")
)
```
 
```{r mytable3, echo=FALSE, warning=FALSE, message=FALSE, fig.cap='Patients Pain Scores with different data patterns, suggesting responses may differ with missing data', fig.height=9, fig.width=14}

## Third plot
data_miss_count <- data_miss %>%
  select(Subject_ID, miss_pattern, pain, time_cont, group_vitd, group_oil, miss_obs) %>%
  group_by(group_vitd, group_oil, miss_pattern, miss_obs, time_cont) %>%
  summarise(pattern_count = n()) %>%
  ungroup %>%
  mutate(pattern_perc = round(pattern_count/sum(pattern_count)*100*5,1))

ggplot(data_miss_count, aes(x = time_cont, y = miss_pattern, fill = miss_obs)) +
  geom_tile(color = "white") + 
  geom_text(data = filter(data_miss_count, time_cont == 4), 
            aes(x = time_cont+1.5, label = paste0(pattern_count," (", pattern_perc, "%)")), size = 4) +
  facet_grid(group_vitd~group_oil, scales = "free", switch = "y") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.spacing.x = unit(1, "lines"),
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  coord_cartesian(xlim = c(-0.5, 6.2), clip = 'off') +
  scale_y_discrete(name = "Missing Data Pattern") +
  scale_fill_discrete(name = "Data Observed\nIndicator (R)", ) +
  scale_x_continuous(name = "Time", breaks = c(0,1,2,3,4,5), 
                     labels = c("Baseline","Year 1","Year 2","Year 3","Year 4","Patient Count\n(%)")) +
  scale_fill_manual(name="Treatment Group",values=c("olivedrab", "lawngreen"))
```

#### 

# Acupuncture Trial

```{r}
# Formating data

library(readr)
library(ggplot2)
acupuncture <- read_csv("Data/acupuncture.csv",show_col_types = FALSE)
acupuncture_miss <- acupuncture %>%
  select(id, group, pk1, pk2, pk5) %>%
  mutate(across(starts_with("pk"), ~ as.numeric(!is.na(.x)), .names = "missing_{.col}")) %>%
  unite("miss_pattern", starts_with("missing_"), remove = FALSE) %>%
  rowwise() %>% 
  mutate(miss_count = sum(c_across(starts_with("missing_pain_")))) %>%
  group_by(miss_pattern) %>%
  mutate(pattern_freq = n()) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(miss_pattern = gsub("_", ", ", miss_pattern),
         miss_pattern_label = paste0("Pattern: ", miss_pattern, ", (n=", pattern_freq , ")", collapse = "")) %>%
  pivot_longer(starts_with("pk"), names_to = "time", names_prefix = "pk", 
               values_to = "pk") %>%
  mutate(
    miss_obs = as.factor(if_else(is.na(pk),0,1)),
    time_cont = case_when(
      time==1 ~ 0,
      time==2 ~ 1,
      time==5 ~ 2
    )) %>%
  arrange(desc(miss_pattern), id) %>%
  mutate(miss_pattern_label = factor(miss_pattern_label, levels = unique(miss_pattern_label)))
```
```{r mytable4, echo=FALSE, warning=FALSE, fig.cap='Proportions of Missing data over time in longitudinal trial (Vickers et al. 2004)', fig.height=6, fig.width=14}
# 1st plot

pct_format = scales::label_percent(accuracy = .1)

acupuncture_miss %>%
  group_by(time, miss_obs) %>%
  summarise(count_pat = n(), .groups = "keep") %>%
  group_by(time) %>%
  mutate(total_pat = sum(count_pat), perc_pat = pct_format(count_pat/total_pat)) %>%
  ungroup %>%
  ggplot(aes(x = time, fill = miss_obs, y = count_pat)) +
  geom_col() +
  stat_identity(geom = "text", colour = "white", size = 10,
                aes(label =perc_pat), 
                position = position_stack(vjust=0.5)) +
  scale_fill_manual(name="",values=c("olivedrab", "lawngreen"), labels=c("Missing Data", "Measured Data")) + 
  scale_x_discrete(name = "Time", labels = c("1" = "Baseline", "2" = "3 Months", "5" = "12 Months")) +
  scale_y_continuous(name = "Number of Patients") +
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 0, vjust = 0.5), legend.position = "top", legend.text=element_text(size=20))
```

```{r mytable5, echo=FALSE, warning=FALSE, fig.cap='Proportions of missing data(dark green) within treatment groups over time', fig.height=6, fig.width=14}
# 2nd plot

acupuncture_miss %>%
  group_by(time, miss_obs, group) %>%
  summarise(count_pat = n(), .groups="keep") %>%
  group_by(time, group) %>%
  mutate(total_pat = sum(count_pat), perc_pat = pct_format(count_pat/total_pat)) %>%
  ungroup %>%
  ggplot(aes(x = time, fill = miss_obs, y = count_pat)) +
  geom_col() + 
  facet_grid(.~group, labeller=labeller(group=c("0" = "Placebo", "1" = "Acupuncture"))) + 
  stat_identity(geom = "text", colour = "white", size = 10,
                aes(label =perc_pat), 
                position = position_stack(vjust=0.5)) +
  scale_fill_manual(name="Data",values=c("olivedrab", "lawngreen"), labels=c("Missing", "Measured")) + 
 scale_x_discrete(name = "Time", labels = c("1" = "Baseline", "2" = "3 Months", "5" = "12 Months")) +
  scale_y_continuous(name = "Number of Patients") +
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 0, vjust = 0.5),legend.position = "none",strip.text.x=element_text(size=20))
```

```{r mytable6, echo=FALSE, warning=FALSE, fig.cap='Missing data (dark green) pattern over time ', fig.height=6, fig.width=14}
## Third plot

acupuncture_miss_count <- acupuncture_miss %>%
  select(id, miss_pattern, pk, time_cont, group, miss_obs) %>%
  group_by(group, miss_pattern, miss_obs, time_cont) %>%
  summarise(pattern_count = n(), .groups="keep") %>%
  ungroup %>%
  mutate(pattern_perc = round(pattern_count/sum(pattern_count)*100*5,1))


ggplot(acupuncture_miss_count, aes(x = time_cont, y = miss_pattern, fill = miss_obs)) +
  geom_tile(color = "white") + 
  geom_text(data = filter(acupuncture_miss_count, time_cont == 2), 
            aes(x = time_cont+1, label = paste0(pattern_count," (", pattern_perc, "%)")), size = 5.5) +
  facet_grid(~group, scales = "free", switch = "y",labeller=labeller(group=c("0" = "Placebo", "1" = "Acupuncture"))) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.spacing.x = unit(1, "lines"),
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 0, vjust = 0.5), legend.position = "none",strip.text.x=element_text(size=20)) +
  coord_cartesian(xlim = c(-0.5, 3.2), clip = 'off') +
  scale_y_discrete(name = "Missing Data Pattern") +
  scale_fill_manual(name = "", labels=c("Missing","Measured"), values=c("olivedrab","lawngreen")) +
  scale_x_continuous(name = "Time", breaks = c(0.1,1.1,2.1,3.1), 
                     labels = c("Baseline","3 Months","12 Months","Patients \n(%)")) 
```


####

# Common Analysis for Data with Missing Observations [^3]
1. Last Observation Carried Forward; Replacing the missing data with the last value that was observed 
2. Simple Imputation; Replacing the missing data with a calculated statistic of the observed data (such as mean or median)
3. Indicator Method; Using a statistical model of the observations, a dummy variable is created to indicate missing or observed.
4. Multiple Imputation; The observed data is used to create a distribution, from which K values are drawn to form K data sets. Each data set is analysed then combined to form an overall effect. 

# GitHub

The code and datasets for this project can be viewed at our GitHub repository here: <https://github.com/amydebrun/Missing-Data.git>

# References
[^1]: MacFarlane, L. A. et al.,(2020). The Effects of Vitamin D and Marine Omega-3 Fatty Acid Supplementation on Chronic Knee Pain in Older US Adults: Results From a Randomized Trial. Arthritis & rheumatology (Hoboken, N.J.), 72(11), 1836–1844. https://doi.org/10.1002/art.41416
[^2]: Vickers, A. J. et al., (2004). Acupuncture for chronic headache in primary care: large, pragmatic, randomised trial. BMJ (Clinical research ed.), 328(7442), 744. https://doi.org/10.1136/bmj.38029.421863.EB
[^3]: Carpenter, J., & Kenward, M. (2007). Missing data in randomised controlled trials: a practical guide. Health Technology Assessment Methodology Programme. 
