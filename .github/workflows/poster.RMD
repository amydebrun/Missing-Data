---
title: Estimating Treatment Effects in Clinical Trials with Missing Data
author:
  - name: Amy Browne
    affil: 1
  - name: Tsz Mang Yip
    affil: 2
affiliation:
  - num: 1
    address: University of Galway, Ireland
  - num: 2
    address: 
column_numbers: 3
output: 
  posterdown::posterdown_html:
    self_contained: false
bibliography: packages.bib
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(haven)
library(gt)
library(scales)
```

# Introduction

Welcome to `posterdown` ! This is my attempt to provide a semi-smooth workflow for those who wish to take their R Markdown skills to the conference world. Most features from R Markdown are available in this package such as Markdown section notation, figure captioning, and even citations like this one [@R-rmarkdown]. The rest of this example poster will show how you can insert typical conference poster features into your own document. 

# Methods

1. Last Observation Carried Forward
2. Mean Imputation
3. Multiple Imputation
4. Indicator Method 

# Methods

This package uses the same workflow approach as the R Markdown you know and love. Basically it goes from RMarkdown > Knitr > Markdown > Pandoc > HTML/CSS > PDF. You can even use the bibliography the same way [@R-posterdown].

# Graphs

Usually you want to have a nice table displaying some important results that you have calculated. In `posterdown` this is as easy as using the `kable` table formatting you are probably use to as per typical R Markdown formatting.

You can reference tables like so: Table \@ref(tab:mytable). Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam placerat augue at velit tincidunt semper. Donec elementum porta posuere. Nullam interdum, odio at tincidunt feugiat, turpis nisi blandit eros, eu posuere risus felis non quam. Nam eget lorem odio. Duis et aliquet orci. Phasellus nec viverra est.

```{r mytable, out.width='80%'}

# Formating data

data_vitalkp <- read_sas("~/Documents/Documents/Work/Galway/Cirriculum/HDS5015 Statistical Computing for Biomedical Data/Github/HDS5106/.github/workflows/Data/vitalkneepain111623.sas7bdat", 
                         NULL)
data_main <- read_sas("~/Documents/Documents/Work/Galway/Cirriculum/HDS5015 Statistical Computing for Biomedical Data/Github/HDS5106/.github/workflows/Data/VITAL_trial_NEJM_2022.sas7bdat", 
                      NULL)

data_combined <- data_main %>%
  select(Subject_ID, vitdactive, fishoilactive) %>%
  right_join(data_vitalkp, by = "Subject_ID")

data_miss <- data_combined %>%
  select(Subject_ID, tkrf, vitdactive, fishoilactive, starts_with("pain_")) %>%
  mutate(across(starts_with("pain_"), ~ as.numeric(!is.na(.x)), .names = "missing_{.col}")) %>%
  unite("miss_pattern", starts_with("missing_"), remove = FALSE) %>%
  rowwise() %>% 
  mutate(miss_count = sum(c_across(starts_with("missing_pain_")))) %>%
  group_by(miss_pattern) %>%
  mutate(pattern_freq = n()) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(miss_pattern = gsub("_", ", ", miss_pattern),
         miss_pattern_label = paste0("Pattern: ", miss_pattern, ", (n=", pattern_freq , ")", collapse = "")) %>%
  pivot_longer(starts_with("pain_"), names_to = "time", names_prefix = "pain_", 
               values_to = "pain") %>%
  mutate(
    miss_obs = as.factor(if_else(is.na(pain),0,1)),
    time_cont = case_when(
      time=="base" ~ 0,
      time=="yr1" ~ 1,
      time=="yr2" ~ 2,
      time=="yr3" ~ 3,
      time=="yr4" ~ 4
    )) %>%
  arrange(desc(miss_pattern), Subject_ID) %>%
  mutate(miss_pattern_label = factor(miss_pattern_label, levels = unique(miss_pattern_label)),
         group_vitd = factor(vitdactive, levels = c(0,1), labels = c("Placebo","Vitamin D")),
         group_oil = factor(fishoilactive, levels = c(0,1), labels = c("Placebo","Fish Oil")))

## Ploting

pct_format = scales::label_percent(accuracy = .1)

data_miss %>%
  group_by(time, miss_obs) %>%
  summarise(count_pat = n()) %>%
  group_by(time) %>%
  mutate(total_pat = sum(count_pat), perc_pat = pct_format(count_pat/total_pat)) %>%
  ungroup %>%
  ggplot(aes(x = time, fill = miss_obs, y = count_pat)) +
  geom_col() + 
  stat_identity(geom = "text", colour = "white", size = 3.5,
                aes(label =perc_pat), 
                position = position_stack(vjust=0.5)) +
  scale_fill_discrete(name = "Data Observed\nIndicator (R)", ) +
  scale_x_discrete(name = "Time") +
  scale_y_continuous(name = "Count (patients)") +
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

## Second plot

data_miss %>%
  group_by(time, miss_obs, group_vitd, group_oil) %>%
  summarise(count_pat = n()) %>%
  group_by(time, group_vitd, group_oil) %>%
  mutate(total_pat = sum(count_pat), perc_pat = pct_format(count_pat/total_pat)) %>%
  ungroup %>%
  ggplot(aes(x = time, fill = miss_obs, y = count_pat)) +
  geom_col() + 
  facet_grid(group_vitd~group_oil) + 
  stat_identity(geom = "text", colour = "white", size = 3.5,
                aes(label =perc_pat), 
                position = position_stack(vjust=0.5)) +
  scale_fill_discrete(name = "Data Observed\nIndicator (R)", ) +
  scale_x_discrete(name = "Time") +
  scale_y_continuous(name = "Count (patients)") +
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5))

## Third plot

ggplot(filter(data_miss, pattern_freq >= 10, miss_count > 2, time_cont > 0), aes(x = time_cont, y = pain)) +
  geom_point(aes(colour=group_oil), alpha = 0.2, size = 3, position = position_jitter(w = 0.1, h = 0)) +
  geom_smooth(aes(colour=group_oil), method = "loess", linewidth = 2) +
  facet_wrap(~miss_pattern_label) +
  scale_x_continuous(name = "Time (year)" ) +
  scale_y_continuous(name = "Pain Score" ) +
  scale_colour_discrete(name = "Randomised Group" ) +
  theme(text = element_text(size = 18))

```

Or with figures: Figure \@ref(fig:standard-plot), or Figure \@ref(fig:morefigs).

```{r standard-plot, out.width='80%', fig.align='center', fig.cap='Great figure!', fig.height=5}
plot(mtcars[1:2])
```

```{r morefigs, out.width='80%', echo=FALSE, fig.cap='Tile graph of the frequency of missing data within these variables', fig.height=5}
library(readr)
library(ggplot2)
acupuncture <- read_csv("Data/acupuncture.csv")
acupuncture$sex<-as.factor(acupuncture$sex)
acupuncture$migraine<-as.factor(acupuncture$migraine)
acupuncture$group<-as.factor(acupuncture$group)

pk5 <- ifelse(is.na(acupuncture$pk5) == 'FALSE', 1, 0)
pk5_missing <- ifelse(is.na(acupuncture$pk5) == 'TRUE', 1, 0)

pk2 <- ifelse(is.na(acupuncture$pk2) == 'FALSE', 1, 0)
pk2_missing <- ifelse(is.na(acupuncture$pk2) == 'TRUE', 1, 0)
Table1<-table(pk2_missing,pk5_missing)
t1<- as.data.frame(Table1)
pk5_missing<- as.data.frame(pk5_missing)
pk2_missing<- as.data.frame(pk2_missing)
ggplot(t1, aes(x = pk2_missing, y = pk5_missing, fill = Freq)) +
  geom_tile() +
  scale_fill_gradient(low = "lightpink", high = "deeppink") +
  labs(title = "Missing Data Pattern: pk2 vs pk5", x = "pk2 Missing", y = "pk5 Missing", fill = "Frequency") +
  theme_minimal()

```

```{r morefigs2, out.width='80%', echo=FALSE, fig.cap='Bar Plot of missing data in pk2 & pk5', fig.height=5}
ggplot(t1, aes(x = interaction(pk2_missing, pk5_missing), y = Freq, fill = interaction(pk2_missing, pk5_missing))) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_fill_manual(values = c("0.0" = "deeppink", "0.1" = "lightcoral", "1.0" = "maroon", "1.1" = "pink")) +
  labs(title = "Missing Data Pattern: pk2 vs pk5", x = "Missing Data Combination (pk2, pk5)", y = "Frequency") +
  theme_minimal() 
```


# Next Steps

Aliquam sed faucibus risus, quis efficitur erat. Vestibulum semper mauris quis tempus eleifend. Aliquam sagittis dictum ipsum, quis viverra ligula eleifend ut. Curabitur sagittis vitae arcu eget faucibus. In non elementum felis. Duis et aliquam nunc. Nunc pulvinar sapien nunc, vel pretium nisi efficitur in. Fusce fringilla maximus leo et maximus. Fusce at ligula laoreet, iaculis mi at, auctor odio. Praesent sed elementum justo. Aenean consectetur risus rhoncus tincidunt efficitur. Praesent dictum mauris at diam maximus maximus [@R-posterdown].

# Conclusion

Try `posterdown` out! Hopefully you like it!

```{r, include=FALSE}
knitr::write_bib(c('knitr','rmarkdown','posterdown','pagedown'), 'packages.bib')
```

# References

```{r}
data<- acupuncture %>%
  select(id, pk1, pk2, pk5, migraine) 

data_miss <- data %>%
  select(id, pk2, pk5, starts_with("pk2_")) %>%
  mutate(across(starts_with("pk2_"), ~ as.numeric(!is.na(.x)), .names = "missing_{.col}")) %>%
  unite("miss_pattern", starts_with("missing_"), remove = FALSE) %>%
  rowwise() %>% 
  mutate(miss_count = sum(c_across(starts_with("missing_pk2_")))) %>%
  group_by(miss_pattern) %>%
  mutate(pattern_freq = n()) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(miss_pattern = gsub("_", ", ", miss_pattern),
         miss_pattern_label = paste0("Pattern: ", miss_pattern, ", (n=", pattern_freq , ")", collapse = "")) %>%
  pivot_longer(starts_with("pain_"), names_to = "time", names_prefix = "pain_", 
               values_to = "pain") %>%
  mutate(
    miss_obs = as.factor(if_else(is.na(pain),0,1)),
    time_cont = case_when(
    time=="base" ~ 0,
    time=="3mths" ~ 1,
    time=="1yr" ~ 2,
  )) %>%
  arrange(desc(miss_pattern), id) %>%
  mutate(miss_pattern_label = factor(miss_pattern_label, levels = unique(miss_pattern_label)),
         group_vitd = factor(vitdactive, levels = c(0,1), labels = c("Placebo","Vitamin D")),
         group_oil = factor(fishoilactive, levels = c(0,1), labels = c("Placebo","Fish Oil")))
```