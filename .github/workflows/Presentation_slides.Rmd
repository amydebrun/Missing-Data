---
title: Estimating Treatment Effects in Longitudinal Clinical Trials with Missing Data
author:
  - name: Amy Browne
  - name: Tsz Mang Yip
output:
   ioslides_presentation:
    css: styles.css
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = FALSE)
library(mice)
library(tidyverse)
library(haven)
library(lme4)
library(broom.mixed)
library(meta)
library(dplyr)
library(naniar)
library(tidymodels)
library(gtsummary)
library(knitr)
library(kableExtra)
source("R scripts/Functions.R")
source("R scripts/VITAL data formats.R")
source("R scripts/Acupuncture data formats.R")
source("R scripts/Summary analysis.R")
source("R scripts/Category time analysis.R")
source("R scripts/Continuous time analysis.R")
source("R scripts/Different Imputation Method.R")
source("R scripts/Sensitive Analysis.R")
source("R scripts/Data_Summary.R")
```

# Background

## Missing Data

Missing data is defined as data that has not been stored for a variable
in the observation of interest. A systematic review of 100 publicized
longitudinal RCTs from 2005 to 2012 (Powney et al 2014) [1] found that:

-   9 did not report missing data
-   44 papers used adequate handling methods
-   30 papers did not use adequate handling methods

This is proof that missing data is becoming recognised as an issue, yet
there is still room for improvement as for choosing proper missing data
approaches and showing their reasoning for their choice.

# Missign Data Assumptions

## Missingness Mechanisms [2]

-   Missing Completely At Random: $$P(R = 1 \mid Y, X) = P(R = 1)$$
-   Missing At Random: $$P(R = 1 \mid Y, X) = P(R = 1 \mid X)$$
-   Missing Not At Random: $$P(R = 1 \mid Y, X) \ne P(R = 1 \mid X)$$
-   We can never confirm these assumptions but Little's MCAR Test can
    help the MCAR assumption

# Study Design & Study Characteristics

## Acupuncture Dataset

- The first dataset is a randomised controlled longitudinal trial which
aims to estimate the effect of acupuncture therapy against a placebo on
headache. 

- There are two follow up time points of 401 participants.

##

```{r, echo=FALSE, fig.height=4, out.width='100%'}
acu_summary
```

## Missing Data Patterns

```{r, echo=FALSE}
acu_wide_miss_plot
```

## VITAL Dataset

This larger dataset is a 2x2 factorial randomised controlled
longitudinal trial. This means there are four combinations of treatment
a patient can be randomised to.

|              | **Vitamin D** | **Placebo** |
|--------------|---------------|-------------|
| **Fish Oil** | N = 342       | N = 353     |
| **Placebo**  | N = 332       | N = 371     |

-   Note: we are only analysing the treatment effect of either fish oil
    or vitamin D, not both.
    
## 

```{r, echo=FALSE, fig.height=4, out.width='100%'}
vital_summary
```

## Missingness data pattern

```{r, echo=FALSE}
vital_wide_miss_plot
```

# Analysis summary

##

| Abbreviation | Method | SLR/LME | SI/MI | MI Method | Mechanism |
|---------------|---------------|---------------|---------------|---------------|-------|
| CAA | Complete Case Analysis | SLR | N/A | N/A | MCAR |
| LOCF | Last Observation Carry Forward | SLR | SI | Last Observation | MCAR |
| MOCF | Mean Observation Carry Forward | SLR | SI | Mean Observation | MCAR |
| LME | LME Only | LME | N/A | N/A | MAR |
| MI | MI Only | SLR | MI | Predictive Mean Matching | MAR |
| LME+MI | LME + MI | LME | MI | Predictive Mean Matching | MAR |


## Original Estimands

- Acupuncture: $\small\text{pk5}_i = \beta_0 + \beta_1 \text{group}_i + \beta_2 \text{pk1}_i + \varepsilon_i$

- VITAL: $\small\text{pain_yr4}_i = \beta_0 + \beta_1\text{fishoilactive}_i +$
$\small\beta_2 \text{vitdactive}_i + \beta_3 \text{pain_base}_i + \varepsilon_i$

## Changing Estimands

-   To determine the effect of changing time from a categorical variable
    to a continuous variable
-   Due to the repetitive measures per individual, we can only estimate
    a continuous estimand using a linear mixed effects model, not a
    linear regression

## Changed Estimands

- Acupuncture: $\small\text{pk_score}_{ij} = \beta_0 + \beta_1  \text{group}_i + $
$\small\beta_2  \text{time}_{ij} + \beta_3 (\text{group}_i \text{time}_{ij}) + \beta_4  \text{pk1}_i + b_{0i} + \varepsilon_{ij}$

- VITAL: $\small\text{pain}_{ij} = \beta_0 + \beta_1  \text{fishoil}_i + \beta_2 \text{time}_{ij} +$
$\small\beta_3(\text{fishoil}_i \text{time}_{ij}) + \beta_4  \text{vitd}_i + \beta_5 (\text{vitd}_i \text{time}_{ij}) +$
$\small\beta_6 \text{pain_base}_i + b_{0i} + \varepsilon_{ij}$

# Approaches to Missing Data

## Complete Case Analysis

-   Only analyse the cases where there are no missing data in any
    variables
-   Popular due to its swift application (also default setting)

Limitations:

-   May be valid when data is MCAR only
-   Reduces statistical power
-   Introduces selection bias

## Single Imputation

-   Replaces missing data with a single value
-   Last observation carried forward: the missing value is replaced by
    the preceding observed measure,
-   Mean observation method: the missing value is replaced by
    the mean value of all observed measure.

Limitations:

-   Limited applicability
-   Reduces variability in the results
-   Assumes data is MCAR

## Linear Mixed Effects Model

-   Linear Mixed Effects Model adjusts to missing data by using maximum
    likelihood estimation
-   Captures subject-specific random effects, which improves model
    accuracy in repeated measures settings
-   It uses all observed data to measure the treatment effect without
    needing to use complete cases only.
-   Suitable for MAR and MCAR

## Multiple Imputation

-   Imputation method to leverage all information we have and involve
    our uncertainty
-   Also suitable for MAR and MCAR
-   Not underestimating the uncertainty

-   We then combine the LME and MI

## Different analysis methods – Acupuncture

```{r, echo=FALSE}
acu_plot_categorical
```

## Different analysis methods – VITAL

```{r, echo=FALSE}
vital_plot_categorical
```


## Changing Estimands – Acupuncture

<div class="columns-2">

```{r, echo=FALSE, out.width='100%'}
acu_plot_compare
```

```{r, echo=FALSE, warning=FALSE, out.width='100%'}
vital_plot_compare
```

Purple: Before changing estimand Green: After changing estimand

</div>

## Further Work

-   Conduct Sensitivity Analysis on both data sets to test sensitivity
    when we deter from the MAR assumption in both treatment and placebo
    group.
-   Try different methods of multiple imputation using chained equations

## Conclusion

-   We have learned how missingness can be handled in many different way
-   It is crucial to understand how each method works and what applies
-   Different method can be more beneficial than others depends on
    dataset

## References

[1]- Powney, M., Williamson, P., Kirkham, J., & Kolamunnage-Dona, R. (2014).
A review of the handling of missing longitudinal outcome data in clinical trials. 
Trials, 15, 237. https://doi.org/10.1186/1745-6215-15-237
[2]- C.A.W. Glas, Missing Data, Editor(s): Penelope Peterson, Eva Baker, Barry McGaw,
International Encyclopedia of Education (Third Edition),Elsevier,2010,
https://doi.org/10.1016/B978-0-08-044894-7.01346-4













# Backup slides

## Different Imputation Methods

| Imputation Methods                        |
|-------------------------------------------|
| Linear Regression Predicted Value         |
| Linear Regression Predicted Value + Noise |
| Random Parameters                         |
| Predictive Mean Matching                  |
| Weighted Predictive Mean Matching         |
| Bayesian Classification                   |

## Different Imputation Methods – ACU

```{r}
acu_plot_imp
```

## Different Imputation Methods – VITAL

```{r}
vital_plot_impt
```

## Sensitivity Analysis (Delta Method) - ACU

```{r}
delta_compare_acu
```

## Sensitivity Analysis (Delta Method) - VITAL

```{r}
delta_combined_fishoil_plot
```

## Sensitivity Analysis

This estimates the treatment effect when data is analysed under
different missingness assumptions. The $δ-Adjustment$ approach shows how
the treatment effect changes when the data is missing not at random.
