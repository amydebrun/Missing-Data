---
title: Estimating Treatment Effects in Longitudinal Clinical Trials with Missing Data
author:
  - name: Amy Browne
  - name: Tsz Mang Yip
output:
   ioslides_presentation:
    css: styles.css
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = FALSE)
library(mice)
library(tidyverse)
library(haven)
library(lme4)
library(broom.mixed)
library(meta)
library(dplyr)
library(naniar)
library(tidymodels)
library(gtsummary)
library(knitr)
library(kableExtra)
source("R scripts/Functions.R")
source("R scripts/VITAL data formats.R")
source("R scripts/Acupuncture data formats.R")
source("R scripts/Summary analysis.R")
source("R scripts/Category time analysis.R")
source("R scripts/Continuous time analysis.R")
source("R scripts/Different Imputation Method.R")
source("R scripts/Sensitive Analysis.R")
```

# Background

## Missing Data

Missing data is defined as data that has not been stored for a variable in the observation of interest. A systematic review of 100 publicized longitudinal RCTs from 2005 to 2012 (Powney et al 2014) [1] found that:

- 9 did not report missing data
- 44 papers used adequate handling methods
- 30 papers did not use adequate handling methods

This is proof that missing data is becoming recognised as an issue, yet there is still room for improvement as for choosing proper missing data approaches and showing their reasoning for their choice.

# Mechanism

## Missingness Mechanisms

-   Missing Completely At Random: $$P(R = 1 \mid Y, X) = P(R = 1)$$
-   Missing At Random: $$P(R = 1 \mid Y, X) = P(R = 1 \mid X)$$
-   Missing Not At Random: $$P(R = 1 \mid Y, X) \ne P(R = 1 \mid X)$$
-   We can never confirm these assumptions but Little's MCAR Test can
    rule out the MCAR assumption

# Study Design & Study Characteristics

## Treatment of Acupuncture on Headache

-   RCT to determine the effect of acupuncture on migraine against a
    placebo

```{r}
acu_wide_miss_plot
```

## Treatment of Acupuncture on Headache

## Treatment of Vitamin D and Fish Oil on Knee Pain

2x2 RCT to compare effect of vitamin D and fish oil on knee pain

```{r}
vital_wide_miss_plot
```

## Treatment of Vitamin D and Fish Oil on Knee Pain


# Missingness in data

# Analysis summary

## Different analysis methods

-   Change imputation methods
-   Change estimands

## Combination of Different Parameters – Summary

| Abbreviation | Method | SLR/LME | SI/MI | MI Method |
|---------------|---------------|---------------|---------------|---------------|
| CAA | Complete Case Analysis | SLR | N/A | N/A |
| LOCF | Last Observation Carry Forward | SLR | SI | Last Observation |
| MOCF | Mean Observation Carry Forward | SLR | SI | Mean Observation |
| LME | LME Only | LME | N/A | N/A |
| MI | MI Only | SLR | MI | Predictive Mean Matching |
| LME+MI | LME + MI | LME | MI | Predictive Mean Matching |

## Treatment Effect of Acupuncture

When treating time as continuous:

Estimand: Difference in mean headache score $pk_score$ at final time
point of 12 months

Linear Regression Model:
$\small\text{pk_score} = \beta_0 + \beta_1 \text{group} + \beta_2  \text{time} + \beta_3  (\text{group}  \text{time}) + \beta_4  \text{pk1} + \varepsilon$

Linear Mixed Effects model:
$\small\text{pk_score}_{ij} = \beta_0 + \beta_1 \text{group}_i + \beta_2  \text{time}_{ij} + \beta_3 (\text{group}_i  \text{time}_{ij}) + \beta_4 \text{pk1}_i + b_{0i} + \varepsilon_{ij}$

## Treatment Effect of Acupuncture

Treating time as categorical

Estimand: Mean difference in headache score $pk5$

Linear Regression Model:
$\small\text{pk5} = \beta_0 + \beta_1  \text{group} + \beta_2 \text{pk1} + \varepsilon$

Linear Mixed Effects:
$\small\text{pk5}_{ij} = \beta_0 + \beta_1  \text{group}_i + \beta_2 \text{pk1}_i + \beta_3  \text{pk2}_{ij} + b_{0i} + \varepsilon_{ij}$











# Approaches to Missing Data

## Complete Case Analysis

-   Only analyse the cases where there are no missing data in any
    variables
-   Popular due to its swift application (also default setting)

Limitations:

-   May be valid when data is MCAR only
-   Reduces statistical power
-   Introduces selection bias

## Single Imputation

-   Replaces missing data with a single value
-   Last observation carried forward: the missing value is replaced by
    the preceding observed measure,
-   Mean observation carried forward: the missing value is replaced by
    the mean value of all observed measure.

Limitations:

-   Limited applicability
-   Reduces variability in the results
-   Assumes data is MCAR

## Linear Mixed Effects Model

-   Linear Mixed Effects Model adjusts to missing data by using maximum
    likelihood estimation
-   Captures subject-specific random effects, which improves model accuracy in repeated measures settings
-   It uses all observed data to measure the treatment effect without
    needing to use complete cases only.
-   Suitable for MAR and MCAR
-   Unbiased estimation and no power loss

## Multiple Imputation 

-   Imputation method to leverage all information we have and involve our uncertainty
-   Also suitable for MAR and MCAR
-   Not underestimating the uncertainty

-   We then combine the LME and MI

## Different analysis methods – Acupuncture

```{r}
acu_plot_categorical
```

## Different analysis methods – VITAL

```{r}
vital_plot_categorical
```

## Changing Estimands – Acupuncture

```{r}
acu_plot_compare
```

Purple: Before changing estimand
Green: After changing estimand

## Changing Estimands – VITAL

```{r}
vital_plot_compare
```

Purple: Before changing estimand
Green: After changing estimand

## Further Work

- Conduct Sensitivity Analysis on both data sets to test sensitivity when we deter from the MAR assumption in both treatment and placebo group.
- Try different methods of multiple imputation using chained equations 

## Conclusion

- We have learned how missingness can be handled in many different way
- It is crucial to understand how each method works and what applies
- Different method can be more beneficial than others depends on dataset

## References 

1- Hunt, Nicholas & Gardarsdottir, Helga & Bazelier, Marloes & Klungel, O.H. & Pajouheshnia, Romin. (2021). A Systematic Review of How Missing Data are Handled and Reported in Multi‐Database Pharmacoepidemiologic studies. Pharmacoepidemiology and Drug Safety. 30. 10.1002/pds.5245









# Backup slides

## Different Imputation Methods

| Imputation Methods                        |
|-------------------------------------------|
| Linear Regression Predicted Value         |
| Linear Regression Predicted Value + Noise |
| Random Parameters                         |
| Predictive Mean Matching                  |
| Weighted Predictive Mean Matching         |
| Bayesian Classification                   |

## Different Imputation Methods – ACU

```{r}
acu_plot_imp
```

## Different Imputation Methods – VITAL

```{r}
vital_plot_impt
```

## Sensitivity Analysis (Delta Method) - ACU

```{r}
delta_compare_acu
```

## Sensitivity Analysis (Delta Method) - VITAL

```{r}
delta_combined_fishoil_plot
```


## Sensitivity Analysis

This estimates the treatment effect when data is analysed under different missingness assumptions. The $δ-Adjustment$ approach shows how the treatment effect changes when the data is missing not at random.